{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}

{% block page_title %}Harvester monitor page{% endblock %}
{% block title %}PanDA monitor{% endblock %}
{% block subtitle %}Harvester <font size=-1>{{ viewParams.selection|safe }}</font> {% endblock %}
{% block body %}
  <link rel="stylesheet" type="text/css" href="/static/js/datatables/datatables.min.css"/>
  <script type="text/javascript" src="/static/js/datatables/datatables.min.js"></script>
  <script type="text/javascript" src="/static/js/datatables/dataTables.rowsGroup.js"></script>
  <script src="/static/js/d3jsplot.js"></script>
  <script type="text/javascript" src="{% static "/js/jquery.shorten.1.0.js" %}"></script>
    <style type="text/css">
        #workerList p{ display:none; }
        #loadMore {color:#0a47ff; cursor:pointer;}
        #loadMore:hover { color:black;}
        #loadAll {color:#0a47ff; cursor:pointer;}
        #loadAll:hover { color:black;}
        #reloadDialogs {color:#0a47ff; cursor:pointer;}
        #reloadDialogs:hover { color:black;}
  </style>

    {% if  type == 'instances'%}
    <table id="harvesterinstances" style="width: 100%">
          <caption  style="height: 30px;vertical-align: middle">Harvester instances</caption>
     <thead>
                <th>Instance</th>
                <th>Total</th>
                <th>Recently</th>
                <th>When</th>
                <th>SW version</th>
                <th>Commit stamp</th>
                <th>Last update</th>
                <th>Description</th>
     </thead>
     <tbody>
     {% for instance in instances %}
     <tr>
         <td>
         <a href="{% url "harvesterfm" %}?instance={{ instance.instance }}&display_limit_workers=30000">{{ instance.instance }}</a>
         </td>
         <td>
         {{ instance.total }}
         </td>
         <td>
         {{ instance.recently }}
         </td>
         <td>
         {{ instance.when }}
         </td>
         <td>
         {{ instance.sw_version }}
         </td>
         <td>
         {{ instance.commit_stamp }}
         </td>
         <td>
         {{ instance.lastupdate }}
         </td>
         <td>
        {{ instance.descr }}
        </td>
     </tr>
     {% endfor %}
     </tbody>
    </table>
    <script>

        $(document).ready(function () {
        $('#harvesterinstances').dataTable({
             "iDisplayLength": 100
        });

    });
    </script>
     {% elif  type == 'workers'%}
        <table>
        {% for name,value in generalInstanseInfo.items %}
            <tr>
                {% if name == 'Statuses'%}
                <td><b>{{ name }} ({{ value|length }})</b></td>
                    <td>
                    {% for n,v in value.items %}
                        <span class='{{ n }} item'>{{ n }}</span> <a href="{{xurl}}status={{ n }}">({{ v }})</a>
                    {% endfor %}
                </td>
                {% elif name ==  'Computingsites' %}
                    <td><b>{{ name }} ({{ value|length }})</b> </td>
                    <td>
                    {% for n,v in value.items %}
                        {{ n }} <a href="{{xurl}}computingsite={{ n }}">({{ v }})</a>
                    {% endfor %}
                </td>
                {% elif name ==  'wrkpandaids' %}
                    <td><b>WorkerID (jobs)</b></td>
                    <td>
                     <div id = 'workerList'>
                    {% for n,v in value.items %}
                         <p>{{ n }} <a href="{% url 'jobList' %}?instance={{ instance }}&workerid={{ n }}">({{ v }})</a></p>
                    {% endfor %}
                     </div>
                    <div id="loadMore" style="display: inline">Load more</div> || <div id="loadAll" style="display: inline">Load all</div>
                    </td>
                {% else %}
                    <td><b>{{ name }}</b></td><td>{{ value }}</td>
            {% endif %}
            </tr>
        {% endfor %}
        </table>
        <hr/>
        <a href="javascript:ReverseDisplay('harvesterdialogsdiv','harvesterdialogslink','harvesterdialogs')" id ="harvesterdialogslink">Show dialog messages</a> <br/><br/>

        <div id="harvesterdialogsdiv" style="display: none">
        <div id="reloadDialogs" style="display: inline">Reload table</div><br/>
        <table id="harvesterdialogs" style="width: 100%">
        <caption  style="height: 30px;vertical-align: middle">Dialog messages from harvester instances</caption>
        <thead>
                <th>Creation time</th>
                <th>Module name</th>
                <th>Message level</th>
                <th>Diag message</th>
          </thead>
          <tbody>

          </tbody>
          </table>

          <hr/>
          </div>
          <table id="harvesterworkers" style="width: 100%">
          <caption  style="height: 30px;vertical-align: middle">Workers submitted by harvesters</caption>
          <thead>
                <th>WorkerID (jobs)</th>
                <th>Total number of jobs</th>
                <th>Last update</th>
                <th>Status</th>
                <th>BatchID</th>
                <th>NodeID</th>
                <th>Queuename</th>
                <th>Computingsite</th>
                <th>Submit time</th>
                <th>Start time</th>
                <th>End time</th>
                <th>Ncore</th>
                <th>Error code</th>
                <th>Stdout</th>
                <th>Stderr</th>
                <th>Batchlog</th>
                <th>Resource type</th>
                <th>Nativeexitcode</th>
                <th>Native status</th>
                <th>Diag message</th>
                <th>Computing element</th>
     </thead>
     <tbody>
     </tbody>
    </table>

   <script>
    $(document).ready(function () {
        var items = 100
        $('#workerList p').slice( 0, items ).show().css("display", "inline");
        var shown =  50;
        $('#loadMore').click(function () {
        var pritems = items
        items = items + shown
        $('#workerList p').slice( pritems, items ).show().css("display", "inline");});
        $('#loadAll').click(function () {
        items = $('#workerList p').length
        $('#workerList p').slice( 0, items ).show().css("display", "inline");});
        $('#reloadDialogs').click(function () {
            $('#harvesterdialogs').DataTable().ajax.reload();
        });
        workersTable();
    });

    function workersTable() {
    $('#harvesterworkers').dataTable({
        //"bRetrieve": true,
        "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
        "paging": true,
        "scrollX": true,
        "ajax": {
            "processing": true,
            "url": "{% url 'harvesterfm' %}?instance={{ instance }}&tk={{ tk }}&dt",
            "dataSrc" : ''},
        "aoColumns": [
            {
                "data": "workerid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    if (type === "sort" || type === 'type') {
                        return data;
                    }
                    else {
                        return ''+full['workerid']+'<a href = "{% url 'jobList' %}?instance={{ instance }}&workerid='+full['workerid']+'">'+' ('+full['harvesterpandaids']+')' +'</a>'
                    }
                }
            },
            {
                "data": "totalpandaids",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{% url 'jobList' %}?workerid='+full['workerid']+'">'+full['totalpandaids']+'</a>'
                 }
            },
            {
                "data": "wrklastupdate",
                sDefaultContent: ""
            },
            {
                "data": "status",
                sDefaultContent: "",
            },
            {
                "data": "batchid",
                sDefaultContent: "",
            },
            {
                "data": "nodeid",
                sDefaultContent: "",
            },
            {
                "data": "queuename",
                sDefaultContent: "",
            },
            {
                "data": "computingsite",
                sDefaultContent: "",
            },
            {
                "data": "submittime",
                sDefaultContent: "",
            },
            {
                "data": "wrkstarttime",
                sDefaultContent: "",
            },
            {
                "data": "wrkendtime",
                sDefaultContent: "",
            },
            {
                "data": "ncore",
                sDefaultContent: "",
            },
            {
                "data": "errorcode",
                sDefaultContent: "",
            },
            {
                "data": "stdout",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (full['stdout']==null)
                    {
                        return ""
                    }
                    else {
                        return '<a href = "' + full['stdout'] + '">' + 'Link' + '</a>'
                    }
                 }
            },
            {
                "data": "stderr",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (full['stderr']==null)
                    {
                        return ""
                    }
                    else {
                        return '<a href = "' + full['stderr'] + '">' + 'Link' + '</a>'
                    }
                 }
            },
            {
                "data": "batchlog",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (full['batchlog']==null)
                    {
                        return ""
                    }
                    else {
                        return '<a href = "' + full['batchlog'] + '">' + 'Link' + '</a>'
                    }
                 }
            },
            {
                "data": "resourcetype",
                sDefaultContent: "",
            },
            {
                "data": "nativeexitcode",
                sDefaultContent: "",
            },
            {
                "data": "nativestatus",
                sDefaultContent: "",
            },
            {
                "data": "diagmessage",
                sDefaultContent: "",
            },
            {
                "data": "computingelement",
                sDefaultContent: "",
            }

        ],
    });}
    function dialogsTable() {
        $('#harvesterdialogs').dataTable({
            "order": [[ 0, "desc" ]],
            "retrieve": true,
            "searching": false,
            "bLengthChange" : false,
            "ajax": {
            "processing": true,
            "url": "{% url 'harvesterfm' %}?instance={{ instance }}&dialogs",
            "dataSrc" : ''},
            "aoColumns": [
            {
                "data": "creationtime",
                sDefaultContent: ""
            },
            {
                "data": "modulename",
                sDefaultContent: ""
            },
            {
                "data": "messagelevel",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (type === "sort" || type === 'type') {
                        return data;
                    }
                    else {
                        var mclass = ''
                        if (full['messagelevel']=='ERROR')
                        {
                            mclass = 'errspan'
                        }
                        else {
                            mclass = full['messagelevel'].toString().toLowerCase()
                        }
                        return ' <span class="'+mclass+'">'+full['messagelevel']+'</span>'
                    }
                 }
            },
            {
                "data": "diagmessage",
                "orderable": false,
                sDefaultContent: "",
            },

            ],
        });
    }
    function ReverseDisplay(d,hlink, table) {
        if(document.getElementById(d).style.display == "none") {
            document.getElementById(d).style.display = "block";
            var urlname = document.getElementById(hlink).innerText;
            urlname = urlname.replace("Show","Hide");
            document.getElementById(hlink).innerText=urlname;
            if(table=='harvesterdialogs'){
                dialogsTable();
            }
        }
        else { document.getElementById(d).style.display = "none";
            var urlname = document.getElementById(hlink).innerText;
            urlname = urlname.replace("Hide","Show");
            document.getElementById(hlink).innerText=urlname;
{#            if(table=='harvesterdialogs'){#}
{#               $('#harvesterdialogs').dataTable().fnDestroy();#}
{#            }#}}
        }
   </script>
    {% endif %}
{% endblock %}


