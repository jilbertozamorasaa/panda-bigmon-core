{% extends "_base_core.html" %}
{% load humanize %}


{% block page_title %} {{ viewParams.MON_VO }} Report on Campaign {% endblock %}
{% block title %} <a href="{% url 'index' %}">{{ viewParams.MON_VO }} Campaign Report</a>{% endblock %}
{% block subtitle %}PanDA {{view}} {{ requestParams.mode }} {{ viewParams.selection|safe }}
{% endblock %}
{% block body %}
    <h1> MC16a Campaign Report<sup>(<a href="#selectioncrit">&#8711;</a>)</sup>
        <span style="float:right;"><h3>Built on {{ built }}</h3></span></h1>

    <section>
        <h3>Outline:</h3>
        <h4><a href="#{{ JediEventsR.title }}">{{ JediEventsR.title }}</a></h4>
        <h4><a href="#{{ totalEvents.title }}">{{ totalEvents.title }}</a></h4>
        <h4><a href="#{{ totalJobs.title }}">{{ totalJobs.title }}</a></h4>
        <h4><a href="#{{ totalTasks.title }}">{{ totalTasks.title }}</a></h4>
        <h4><a href="#{{ recentTasks.title }}">{{ recentTasks.title }}</a></h4>
        <h4><a href="#siteshighestHS06SECfailed">List of top sites with  spent on failed jobs</a></h4>
        <h4><a href="#siteshighestactivatedrunning">List of the top sites with the highest activated/running ratio</a></h4>
        <h4><a href="#siteshighestassignedrunning">List of the top sites with the highest assigned/running ratio</a></h4>
    </section>

    <p></p><p></p>


    <table id="{{ JediEventsR.title }}">
        <tr>
            <th colspan=20>{{ JediEventsR.title }}</th>
        </tr>
        <tr>
            <th>Input Events</th>
            <th>Simulated</th>
            <th>HITS Merged</th>
            <th>Reconsructed</th>
            <th>AOD Merged</th>
        </tr>

         <tr>
                <td>{{ JediEventsR.input|intcomma }}</td>
                <td>{{ JediEventsR.simulated|intcomma }} ({{ JediEventsR.simulatedprogr }}%)</td>
                <td>{{ JediEventsR.mergeHits|intcomma }} ({{ JediEventsR.mergeHitsprog }}%)</td>
                <td>{{ JediEventsR.reconstructed |intcomma}} ({{ JediEventsR.reconstructedprog }}%)</td>
                <td>{{ JediEventsR.merge|intcomma }} ({{ JediEventsR.mergeprog }}%)</td>
         </tr>

    </table>


    {% comment %}
    <script type="text/javascript">
        function toggleTable(hashtag) {
            var lTable = document.getElementById(hashtag);
            lTable.style.display = (lTable.style.display == "table") ? "none" : "table";
        };
    </script>

    <table>
        <tr><th>Overall events processing summary, avaliable #HashTags breakdown</th></tr>
        <tr><td>
            {% for hashtag in hashTable %}
                <a onclick="javascript:toggleTable('{{ hashtag }}')"> {{ hashtag }} </a>
            {% endfor %}
        </td></tr>
    </table>

    {% for data in JediEventsHashsTable %}
    <table id="{{ data.hashtag }}" style="display: none">
        <tr>
            <th colspan=20>Overall events processing summary, HashTag: #{{ data.hashtag }}</th>
        </tr>
        <tr>
            <th></th>
            <th>Event Generation</th>
            <th>Simulation</th>
            <th>Reconstruction</th>
            <th>Merge</th>
        </tr>
        {% for key, values in data.items %}
            {% ifnotequal key 'hashtag' %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ values.evgen }}</td>
                <td>{{ values.simul }}</td>
                <td>{{ values.recon }}</td>
                <td>{{ values.merge }}</td>
            </tr>
            {% endifnotequal %}
        {% endfor %}
    </table>
    {% endfor %}
    {% endcomment %}



    <table id="{{ totalEvents.title }}">
        <tr>
            <th colspan=24>{{ totalEvents.title }}</th>
        </tr>
        <tr>
            <td></td>
            {% for state in jobstatelist %}
                <td class="{{ state }}"> <b> {{ state }} </b> </td>
            {% endfor %}
        </tr>
            {% for step in steps %}
                <tr>
                <td>
                    {{ stepsLabels|get_item:step }}
                </td>

                {% for state in jobstatelist %}
                    <td>
                        {% if totalEvents|get_item:step|get_item:state > 0 %}
                            {{ totalEvents|get_item:step|get_item:state|intcomma }}
                        {% endif %}
                    </td>
                {% endfor %}

                </tr>
            {% endfor %}

    </table>

    <table id="{{ totalJobs.title }}">
        <tr>
            <th colspan=24>{{ totalJobs.title }}</th>
        </tr>
        <tr>
            <td></td>
            {% for state in jobstatelist %}
                <td class="{{ state }}"> <b> {{ state }} </b> </td>
            {% endfor %}
        </tr>
            {% for step in steps %}
                <tr>
                <td>
                    {{ stepsLabels|get_item:step }}
                </td>

                {% for state in jobstatelist %}
                    <td>
                        {% if totalJobs|get_item:step|get_item:state > 0 %}
                            {{ totalJobs|get_item:step|get_item:state|intcomma }}
                        {% endif %}
                    </td>
                {% endfor %}

                </tr>
            {% endfor %}

    </table>

    <table id="{{ totalTasks.title }}">
        <tr>
            <th colspan=24>{{ totalTasks.title }}</th>
        </tr>
        <tr>
            <td></td>
            {% for state in taskstatelistDEFT %}
                {% if state == 'done+finished' %}
                    <td class="done"> <b> {{ state }} </b> </td>
                {% else %}
                    <td class="{{ state }}"> <b> {{ state }} </b> </td>
                {% endif %}
            {% endfor %}
        </tr>
            {% for step in steps %}
                <tr>
                <td>
                    {{ stepsLabels|get_item:step }}
                </td>

                {% for state in taskstatelistDEFT %}
                    <td>
                        {% if totalTasks|get_item:step|get_item:state > 0 %}
                            <a href='/tasks/?status={{ state }}&campaign=MC16*&taskname=*.{{ step }}.*&days=300&reqid=11035|11034|11048|11049|11050|11051|11052|11198|11197|11222|11359'>{{ totalTasks|get_item:step|get_item:state }}</a>
                        {% endif %}
                    </td>
                {% endfor %}

                </tr>
            {% endfor %}

    </table>
    <p>Merge links may not provide corespondent number due to additional filtering which should be applied to select true merge tasks


    <table id="{{ recentTasks.title }}">
        <tr>
            <th colspan=24>{{ recentTasks.title }}</th>
        </tr>
        <tr>
            <td></td>
            {% for state in taskstatelistRecent %}
                <td class="{{ state }}"> <b> {{ state }} </b> </td>
            {% endfor %}
        </tr>
            {% for step in steps %}
                <tr>
                <td>
                    {{ stepsLabels|get_item:step }}
                </td>

                {% for state in taskstatelistRecent %}
                    <td>
                        {% if recentTasks|get_item:step|get_item:state > 0 %}
                            {{ recentTasks|get_item:step|get_item:state }}
                        {% endif %}
                    </td>
                {% endfor %}

                </tr>
            {% endfor %}

    </table>
    <p>(*) Tasks updated during last 24 hours
    <br>(**) All current tasks
    <br>(***) Tasks submitted during last 24 hours


    <table id="{{ hepspecJobs.title }}">
        <tr>
            <th colspan=20>{{ hepspecJobs.title }}</th>
        </tr>
        <tr>
            <th></th>
            <th>Event Generation</th>
            <th>Simulation</th>
            <th>Reconstruction</th>
            <th>Merge</th>
        </tr>

        {% for key, values in hepspecJobs.items %}
            {%if  key != 'title' and key != 'total' %}
                <tr>
                    <td>{{ key }}</td>
                    <td>{{ values.evgen|intcomma }}</td>
                    <td>{{ values.simul|intcomma }}</td>
                    <td>{{ values.recon|intcomma }}</td>
                    <td>{{ values.merge|intcomma }}</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>


    <table id="siteshighestHS06SECfailed">
        <tr>
            <th colspan=20>List of top sites with  spent on failed jobs</th>
        </tr>
        <tr>
            <th>Computingsite</th>
            <th>Failed hs06sec</th>
            <th>Count</th>
            <th>Errors</th>
        </tr>

        {% for values in worstSite %}
                <tr>
                    <td>{{ values.COMPUTINGSITE }}</td>
                    <td>{{ values.FAILEDHS06SEC|intcomma }}</td>
                    <td>{{ values.COUNT|intcomma }}</td>
                    <td>{{ values.ERRORS }}</td>
                </tr>
        {% endfor %}
    </table>


    <table id="siteshighestactivatedrunning">
        <tr>
            <th colspan=20>List of the top sites with the highest activated/running ratio</th>
        </tr>
        <tr>
            <th>Site</th>
            <th>Step</th>
            <th>activated/running jobs</th>
            <th>activated jobs</th>
            <th>running jobs</th>
        </tr>

        {% for values in siteActRun %}
                <tr>
                    <td>{{ values.COMPUTINGSITE }}</td>
                    <td>{{ values.STEP }}</td>
                    <td>{{ values.acttorun|floatformat:2|intcomma }}</td>
                    <td>{{ values.SA }}</td>
                    <td>{{ values.SR }}</td>
                </tr>
        {% endfor %}
    </table>

    <table id="siteshighestassignedrunning">
        <tr>
            <th colspan=20>List of the top sites with the highest assigned/running ratio</th>
        </tr>
        <tr>
            <th>Site</th>
            <th>Step</th>
            <th>assigned/running jobs</th>
            <th>assigned jobs</th>
            <th>running jobs</th>
        </tr>

        {% for values in siteAssignRun %}
                <tr>
                    <td>{{ values.COMPUTINGSITE }}</td>
                    <td>{{ values.STEP }}</td>
                    <td>{{ values.acttorun|floatformat:2|intcomma }}</td>
                    <td>{{ values.SA }}</td>
                    <td>{{ values.SR }}</td>
                </tr>
        {% endfor %}
    </table>

    <h5 id="selectioncrit">Additional selection by requests {{ requestList }} applied </h5>


{% endblock %}
