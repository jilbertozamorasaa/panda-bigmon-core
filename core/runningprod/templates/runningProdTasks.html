{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}
{% block page_title %} PanDA tasks{% endblock %}
{% block subtitle %}Running production task list
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
    <style>
        #tasklist_wrapper .row {
            max-width: 99%;
        }
    </style>
{% endblock %}
{% block extra_js %}
    <script src="{% static 'js/humanize.min.js' %}"></script>
    <script src="/static/js/d3jsplot.js"></script>
    <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
    <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
{% endblock %}
{#<script type="text/javascript" src="{% static "/js/jquery-1.9.1.min.js"%}"></script>#}
{% block body %}

    {% if requestParams.campaign %}<br><b>Campaign:</b> {{ requestParams.campaign }} {% endif %}
    {% if requestParams.status %}<br><b>Status:</b> {{ requestParams.status }} {% endif %}
    {% if requestParams.corecount %}<br><b>Core count:</b> {{ requestParams.corecount }} {% endif %}
    {% if requestParams.username %}<br><b>User name:</b> {{ requestParams.username }} {% endif %}
    {% if requestParams.inputdataset %}<br><b>Input dataset:</b> {{ requestParams.inputdataset }} {% endif %}
    {% if requestParams.reqid %}<br><b>Request ID:</b> {{ requestParams.reqid }} {% endif %}
    {% if requestParams.ptag %}<br><b>pTag:</b> {{ requestParams.ptag }} {% endif %}
    {% if requestParams.workinggroup %}<br><b>Working group:</b> {{ requestParams.workinggroup }} {% endif %}
    {% if requestParams.processingtype %}<br><b>Processingtype:</b> {{ requestParams.processingtype }} {% endif %}
    {% if requestParams.site %}<br><b>Site:</b> {{ requestParams.site }} {% endif %}
    {% if requestParams.gshare %}<br><b>Global Share:</b> {{ requestParams.gshare }} {% endif %}
    <p>
        <script>
            var numberOfRunning = 0;
            var numberOfWaiting = 0;
            var c = 0;
            var ntasks = {{ ntasks }};
            function insertReply(content) {
                alert(content);
            }

        </script>


            <script>
                function onPresetChoice () {
                    var presetChoice = document.getElementById ("presetChoice");
                    var workinggroup = document.getElementById ("workinggroup");
                    var processingtype = document.getElementById ("processingtype");
                    var campaign = document.getElementById ("campaign");
                    var status = document.getElementById ("status");
                    var warning = document.getElementById ("warning");

                    if (presetChoice.value == 'MC') {
                        workinggroup.selectedIndex = 1;
                        processingtype.selectedIndex = 1;
                        campaign.selectedIndex = 1;
                        status.selectedIndex = 0;
                    }

                    if (presetChoice.value == 'DPD') {
                        workinggroup.selectedIndex = 2;
                        processingtype.selectedIndex = 2;
                        campaign.selectedIndex = 0;
                        status.selectedIndex = 0;
                    }

                    if (presetChoice.value == 'DATA') {
                        workinggroup.selectedIndex = 3;
                        processingtype.selectedIndex =3;
                        campaign.selectedIndex =0;
                        status.selectedIndex = 0;
                    }


                    if (presetChoice.value == '') {
                        workinggroup.selectedIndex = 0;
                        processingtype.selectedIndex = 0;
                        campaign.selectedIndex = 0;
                        status.selectedIndex = 0;
                    }
                    warning.style.display = '';
                }

                function onSubElementChoice() {
                    var warning = document.getElementById ("warning");
                    warning.style.display = '';
{#                    var presetChoice = document.getElementById ("presetChoice");#}
{#                    presetChoice.selectedIndex = 2;#}

                }
                function go() {

                    var workinggroupQ = "";
                    var processingtypeQ = "";
                    var campaignQ = "";
                    var presetQ = "";
                    var statusQ = "";
                    var hpcsitesQ = "";
                    var esQ = "";
                    var workinggroup = document.getElementById ("workinggroup");
                    var processingtype = document.getElementById ("processingtype");
                    var campaign = document.getElementById ("campaign");
                    var presetChoice = document.getElementById ("presetChoice");
                    var query = {% url 'runningProdTasks' %} ;
                    var status = document.getElementById ("status");
                    var hpcsites = document.getElementById('hpc');
                    var es = document.getElementById('es');

                    if (workinggroup.value.length > 0) workinggroupQ = "workinggroup="+workinggroup.value;
                    if (processingtype.value.length > 0) processingtypeQ = "processingtype="+processingtype.value;
                    if (campaign.value.length > 0) campaignQ = "campaign="+campaign.value;
                    if (presetChoice.value.length > 0) presetQ = "preset="+presetChoice.value;
                    if (status.value.length > 0) statusQ = "status="+status.value;
                    if (hpcsites.checked) hpcsitesQ = "site="+hpcsites.value;
                    if (es.checked) esQ = "eventservice="+es.value;

                    if ((workinggroupQ.length>1) || (processingtypeQ.length>1) || (campaignQ.length>1) || (presetQ.length > 1) || (statusQ.length > 1) || (hpcsitesQ.length > 1) || (esQ.length > 1)) {
                        query += "?";
                        if (presetQ.length > 1) {
                            query += presetQ+"&";
                        }
                        if (workinggroupQ.length > 1) {
                            query += workinggroupQ+"&";
                        }
                        if (processingtypeQ.length > 1) {
                            query += processingtypeQ+"&";
                        }
                        if (campaignQ.length > 1) {
                            query += campaignQ+"&";
                        }
                        if (statusQ.length > 1) {
                            query += statusQ+"&";
                        }
                        if (hpcsitesQ.length > 1) {
                            query += hpcsitesQ+"&";
                        }
                        if (esQ.length > 1) {
                            query += esQ+"&";
                        }
                        query = query.substring(0, query.length - 1);
                    }
                    window.location = query;
                }
            </script>


            <table class="minimalistic-table">
              <thead>
                <tr>
                    <th>Selection Preset</th>
                    <th>Working group</th>
                    <th>Processing type</th>
                    <th>Campaign</th>
                    <th>Status</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                    <td>
                        <select id="presetChoice" onchange="onPresetChoice()">
                            <option value="MC"
                                {% if requestParams.preset == 'MC' %} selected="selected" {% endif %}
                                >MC</option>
                            <option value="DPD"
                                {% if requestParams.preset == 'DPD' %} selected="selected" {% endif %}
                                >DPD</option>
                            <option value="DATA"
                                {% if requestParams.preset == 'DATA' %} selected="selected" {% endif %}
                                >DATA</option>
                            <option value=""
                                {% if requestParams.preset != 'DPD' and requestParams.preset != 'MC'  and requestParams.preset != 'DATA' %} selected="selected" {% endif %}>All</option>
                        </select>
                    </td>
                    <td>
                        <select id="workinggroup" onchange="onSubElementChoice()">
                            <option value=""  selected="selected"
                                {% if requestParams.preset == 'MC' %} disabled="disabled" {% endif %}
                            >All</option>
                            <option value="!AP_REPR,!AP_VALI,!GP_PHYS,!GP_THLT"
                                {% if requestParams.workinggroup == '!AP_REPR,!AP_VALI,!GP_PHYS,!GP_THLT' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'MC' and requestParams.workinggroup != '!AP_REPR,!AP_VALI,!GP_PHYS,!GP_THLT' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
                            >NOT IN ('AP_REPR', 'AP_VALI', 'GP_PHYS', 'GP_THLT')</option>
                            <option value="GP_*"
                                {% if requestParams.preset == 'DPD' and requestParams.workinggroup == 'GP_*' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'MC' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
                            >GP_*</option>

                            <option value="AP_REPR"
                                {% if requestParams.preset == 'DATA' or requestParams.workinggroup == 'AP_REPR' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'MC' or requestParams.preset == 'DPD' %} disabled="disabled" {% endif %}
                            >AP_REPR</option>


                            {% if requestParams.preset != 'DATA' %}
                                {% for field in sumd %}
                                    {% if field.field == 'workinggroup' %}
                                        {% for wg in field.list %}
                                            <option value={{ wg.kname }}
                                                {% if wg.kname == requestParams.workinggroup %} selected="selected" {% endif %}>
                                                {{ wg.kname }} </option>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </td>
                    <td>
                        <select id="processingtype" onchange="onSubElementChoice()">
                            <option value=""  selected="selected"
                                {% if requestParams.preset == 'MC' %} disabled="disabled" {% endif %}
                            >All</option>
                            <option value="evgen|pile|simul|recon"
                                {% if requestParams.preset == 'MC'  or requestParams.processingtype == 'evgen|pile|simul|recon' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
                            >evgen|pile|simul|recon</option>
                            <option value="merge|deriv"
                                {% if requestParams.preset == 'DPD' or requestParams.processingtype == 'merge|deriv' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'MC' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
                            >merge|deriv</option>

                            <option value="reprocessing"
                                {% if requestParams.processingtype == 'reprocessing' or requestParams.preset == 'DATA' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'MC' or requestParams.preset == 'DPD' %} disabled="disabled" {% endif %}
                            >reprocessing</option>

                            {% if requestParams.preset != 'DATA' %}
                                {% for ptype in sumd.1.list %}
                                        <option value={{ ptype.kname }}
                                            {% if ptype.kname == requestParams.processingtype %} selected="selected" {% endif %}>
                                            {{ ptype.kname }} </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </td>
                    <td>
                        <select id="campaign" onchange="onSubElementChoice()">
                            <option value=""  selected="selected">All</option>
                            <option value="MC*"
                                {% if requestParams.preset == 'MC' or requestParams.campaign == 'MC*' %} selected="selected" {% endif %}
                                {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
                            > like 'MC%'</option>
                                {% for campaign in sumd.0.list %}
                                    <option value="*{{ campaign.kname }}*"
                                        {% if campaign.kname in requestParams.campaign %} selected="selected" {% endif %}
                                    >{{ campaign.kname }} </option>
                                {% endfor %}

                        </select>
                    </td>
                    <td>
                        <select id="status" onchange="onSubElementChoice()">
                            <option value=""  selected="selected">All</option>
                            {% for status in sumd.2.list %}
                                <option value={{ status.kname }}
                                    {% if status.kname == requestParams.status %} selected="selected" {% endif %}
                                > {{ status.kname }} </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" id="hpc" name="hpc" value="hpc" onchange="onSubElementChoice()"
                        {% if requestParams.site == 'hpc' %} checked {% endif %}>HPC
                    </td>
                    <td>
                        <input type="checkbox" id="es" name="es" value="1" onchange="onSubElementChoice()"
                        {% if requestParams.eventservice == '1' %} checked {% endif %}>ES
                    </td>
                    <td>
                        <a onclick="go()" class="button primary">Go!</a>
                    </td>
                </tr>
              </tbody>
            </table>
    <p>
    <div id="warning" style="display:none"> <span class="warning" style="font-size: 24px">Data is out of date since you changed selection. Press GO! button to apply changes. </span></div>
    <p>
        {% if tasks %}

            <table class="minimalistic-table unstriped">
              <thead>
                <tr>
                    <th> Events</th>
                    <th> Allocated slots</th>
                    <th> Task age</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                    <td>
                        <div class="row">
                        {% if requestParams.preset == 'MC' %}
                            {% if neventsFStasksSum|length > 0 %}<div class="d3splot" id="pieChartFS" style="float:left"></div>{% endif %}
                            {% if neventsAFIItasksSum|length > 0 %}<div class="d3splot" id="pieChartAFII" style="float:left"></div>{% endif %}
                        {% else %}
                            {% if neventsByProcessingType|length > 0 %}<div class="d3splot" id="pieChartByPT" style="float:left"></div>{% endif %}
                        {% endif %}
                        </div>
                    </td>
                    <td>{% if aslotsByType|length > 0 %}<div class="d3splot" id="pieChartSlots"></div>{% endif %}</td>
                    <td colspan=20>{% if plotageshistogram == 1 %}
                        <div class="d3splot" id="sumPlot" style="float:left"></div>{% else %}
                        <p> All tasks age is 0 days</p> {% endif %} </td>
                </tr>
                <tr>
                <td colspan=20>
                    Total events done <b>{{ neventsUsedTotSum }}M</b> of <b>{{ neventsTotSum }}M</b> in
                    <b>{{ ntasks }}</b> tasks <br>
                    Number of currently running events <b>{{ neventsRunningTotSum }}M</b> <br>
                    Number of waiting events <b>{{ neventsWaitingTotSum }}M</b> <br>
                    Total 1-core jobs <b>{{ rjobs1coreTot }}</b> and 8-cores <b>{{ rjobs8coreTot }}</b> jobs
                </td>
                </tr>
              </tbody>
            </table>
            <script>
                var progressBarR = $('#runningprogressbar');
                var progressBarW = $('#waitingprogressbar');
                var ages = {{ ages|safe }};
                var productiontype = {{ productiontype | safe }};
                var plotageshistogram = {{ plotageshistogram }};
                if (plotageshistogram == 1) {
                    pandamonProdRunTaskSumPlotFunc(ages, "#sumPlot", 'Task age histogram', 24, productiontype);
                }
                var neventsFStasksSum ={{ neventsFStasksSum|safe }};
                var neventsAFIItasksSum ={{ neventsAFIItasksSum|safe }};
                var neventsByProcessingType ={{ neventsByProcessingType|safe }};
                if (productiontype == 'MC') {
                    runningProdTasksPieChartFunc(neventsFStasksSum, "#pieChartFS", 'FS');
                    runningProdTasksPieChartFunc(neventsAFIItasksSum, "#pieChartAFII", 'AFII');
                }
                else {
                    runningProdTasksPieChartFunc(neventsByProcessingType, "#pieChartByPT", 'N Events')
                }

                var slots = {{ aslotsByType|safe }};
                runningProdTasksPieChartFunc(slots, '#pieChartSlots', 'Slots');

                {#var gauges = [];#}
                {#$(document).ready(function() {#}
                {#createGauge("slots", "Slots");#}
                {#gauges['slots'].redraw(slots);});#}


            </script>


            <table id = 'tasklist' class="data-table">
                <thead>
{#                <tr class='tablesection'>#}
{#                    <th colspan=25> {{ ntasks }} tasks</th>#}
{#                </tr>#}
                <tr>
                    <th>Campaign</th>
                    <th>Req ID</th>
                    <th>Run</th>
                    <th>Task ID</th>
                    <th>RJobs</th>
                    <th>Status (PS2)</th>
                    <th>Status (JEDI)</th>
                    {% if requestParams.preset != 'DPD' %}
                        <th>Type</th>
                    {% endif %}
                    <th>Evts total</th>
                    <th>Evts done</th>
                    <th>Evts running</th>
                    <th>Evts to be used</th>
                    <th>%</th>
                    <th>Failed files</th>
                    <th>Priority</th>
                    {% if requestParams.preset == 'DPD' %}
                        <th>pTag</th>
                        <th>Output types</th>
                    {% endif %}
                    {% if requestParams.preset == 'MC' %}
                        <th>Sim</th>
                    {% endif %}
                    <th>Age</th>
                    <th>Cores</th>
                    {% if requestParams.preset == 'MC' or requestParams.preset == '' %}
                        <th>User</th>
                    {% endif %}
                    <th>CPU Time per Event</th>
                    <th>Global Share</th>
                    <th>Site</th>
                    <th>Hastags</th>
                </tr>
                </thead>
            <tbody>
            </tbody>
            </table>




        {% else %}
            <p>No matches to query.</p>
        {% endif %}

<script>
    $(document).ready(function () {
        var preset = {{ productiontype|safe }};
        if (preset === 'MC') {
            taskListMCTable();
        }
        else if (preset === 'DPD') {
            taskListDPDTable();
        }
        else {
            taskListDataTable();
        }
    });
    function taskListMCTable() {
      $('#tasklist').dataTable({
        //"bRetrieve": true,
        "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
        "paging": true,
        "scrollX": true,

        "ajax": {
            "processing": true,
            "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
        "dataSrc" : ''},            "columnDefs": [
            {"type": "num-html", "targets": [2,4,8,9,10,11,12,13,14,16,17,19] }
        ],
        "aoColumns": [
            {
                "data": "cutcampaign",
                sDefaultContent: "---",
                "render": function(data, type, row, meta) {
                    return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
                 }
            },
            {
                "data": "reqid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/reqtask/' + full['reqid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "inputdataset",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}inputdataset=' + full['runnumber'] + '">' + full['runnumber'] + '</a>'
                }
            },
            {
                "data": "jeditaskid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['jeditaskid'] + '">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "rjobs",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (data > 0) {
                        return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                    }
                    else {
                        return data;
                    }
                }
            },
            {
                "data": "superstatus",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
                }
            },
            {
                "data": "status",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
                }
            },
            {
                "data": "processingtype",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}processingtype=' + full['processingtype'] + '">' + full['processingtype'] + '</a>'
                }
            },
            {
                "data": "nevents",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')

            },
            {
                "data": "neventsused",
                sDefaultContent: "",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventsrunning",
                sDefaultContent: "0",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventstobeused",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "percentage",
                sDefaultContent: "",
            },
            {
                "data": "nfilesfailed",
                sDefaultContent: "---",
            },
            {
                "data": "priority",
                sDefaultContent: "",
            },
            {
                "data": "simtype",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}simtype=' + full['simtype'] + '">' + full['simtype'] + '</a>'
                }
            },
            {
                "data": "age",
                sDefaultContent: "",
            },
            {
                "data": "corecount",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
                }
            },
            {
                "data": "username",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}username=' + full['username'] + '">' + full['username'] + '</a>'
                }
            },
            {
                "data": "cputime",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "gshare",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
                }
            },
            {
                "data": "site",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (data) {
                        return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
                    }
                    else {
                        return '---';
                    }
                }
            },
            {
                "data": "hashtags",
                sDefaultContent: "---",
                "render": function ( data, type, row ) {
                    if (data.length > 0) {
                        var xurl = '{{ xurl|safe }}';
                        var hashtaglist = data.split(',');
                        var hashtaglinks = '';
                        for (var i = 0; i < hashtaglist.length; i++) {
                            if (xurl.indexOf('hashtags') > -1) {
                                hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                            else
                            {
                                hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                        }
                        return hashtaglinks;
                    }
                    else {
                        return '---'
                    }
                }
            }

        ],
        "createdRow": function ( row, data, index ) {
            $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
            $('td', row).eq(6).addClass(data['status'] + '_fill');
        }
      });
    }

    function taskListDPDTable() {
      $('#tasklist').dataTable({
        //"bRetrieve": true,
        "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
        "paging": true,
        "scrollX": true,

        "ajax": {
            "processing": true,
            "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
            "dataSrc" : ''},
        "aoColumns": [
            {
                "data": "cutcampaign",
                sDefaultContent: "---",
                "render": function(data, type, row, meta) {
                    return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
                 }
            },
            {
                "data": "reqid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/reqtask/' + full['reqid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "inputdataset",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}inputdataset=' + full['runnumber'] + '">' + full['runnumber'] + '</a>'
                }
            },
            {
                "data": "jeditaskid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['jeditaskid'] + '">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "rjobs",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (data > 0) {
                        return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                    }
                    else {
                        return data;
                    }
                }
            },
            {
                "data": "superstatus",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
                }
            },
            {
                "data": "status",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
                }
            },
            {
                "data": "nevents",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventsused",
                sDefaultContent: "",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventsrunning",
                sDefaultContent: "0",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventstobeused",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "percentage",
                sDefaultContent: "",
            },
            {
                "data": "nfilesfailed",
                sDefaultContent: "---",
            },
            {
                "data": "priority",
                sDefaultContent: "",
            },
            {
                "data": "ptag",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}ptag=' + full['ptag'] + '">' + full['ptag'] + '</a>'
                }
            },
            {
                "data": "outputtypes",
                sDefaultContent: "",
            },
            {
                "data": "age",
                sDefaultContent: "",
            },
            {
                "data": "corecount",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
                }
            },
            {
                "data": "cputime",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "gshare",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
                }
            },
            {
                "data": "site",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
                }
            },
            {
                "data": "hashtags",
                sDefaultContent: "---",
                "render": function ( data, type, row ) {
                    if (data.length > 0) {
                        var xurl = '{{ xurl|safe }}';
                        var hashtaglist = data.split(',');
                        var hashtaglinks = '';
                        for (var i = 0; i < hashtaglist.length; i++) {
                            if (xurl.indexOf('hashtags') > -1) {
                                hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                            else
                            {
                                hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                        }
                        return hashtaglinks;
                    }
                    else {
                        return '---'
                    }
                }
            }

        ],
        "createdRow": function ( row, data, index ) {
            $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
            $('td', row).eq(6).addClass(data['status'] + '_fill');
        }
      })
    }


    function taskListDataTable() {
      $('#tasklist').dataTable({
        //"bRetrieve": true,
        "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
        "paging": true,
        "scrollX": true,

        "ajax": {
            "processing": true,
            "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
            "dataSrc" : ''},
        "aoColumns": [
            {
                "data": "cutcampaign",
                sDefaultContent: "---",
                "render": function(data, type, row, meta) {
                    return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
                 }
            },
            {
                "data": "reqid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/reqtask/' + full['reqid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "inputdataset",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}inputdataset=' + full['runnumber'] + '">' + full['runnumber'] + '</a>'
                }
            },
            {
                "data": "jeditaskid",
                sDefaultContent: "",
                "render": function ( data, type, full, meta ) {
                    return '<a href = "{{ xurl }}reqid=' + full['jeditaskid'] + '">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
                }
            },
            {
                "data": "rjobs",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    if (data > 0) {
                        return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                    }
                    else {
                        return data;
                    }
                }
            },
            {
                "data": "superstatus",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
                }
            },
            {
                "data": "status",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
                }
            },
            {
                "data": "processingtype",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}processingtype=' + full['processingtype'] + '">' + full['processingtype'] + '</a>'
                }
            },
            {
                "data": "nevents",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventsused",
                sDefaultContent: "",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventsrunning",
                sDefaultContent: "0",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "neventstobeused",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "percentage",
                sDefaultContent: "",
            },
            {
                "data": "nfilesfailed",
                sDefaultContent: "---",
            },
            {
                "data": "priority",
                sDefaultContent: "",
            },
            {
                "data": "age",
                sDefaultContent: "",
            },
            {
                "data": "corecount",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
                }
            },
            {
                "data": "cputime",
                sDefaultContent: "---",
                render: $.fn.dataTable.render.number( ',', '.')
            },
            {
                "data": "gshare",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
                }
            },
            {
                "data": "site",
                sDefaultContent: "",
                "render": function(data, type, full, meta) {
                    return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
                }
            },
            {
                "data": "hashtags",
                sDefaultContent: "---",
                "render": function ( data, type, row ) {
                    if (data.length > 0) {
                        var xurl = '{{ xurl|safe }}';
                        var hashtaglist = data.split(',');
                        var hashtaglinks = '';
                        for (var i = 0; i < hashtaglist.length; i++) {
                            if (xurl.indexOf('hashtags') > -1) {
                                hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                            else
                            {
                                hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                            }
                        }
                        return hashtaglinks;
                    }
                    else {
                        return '---'
                    }
                }
            }

        ],
        "createdRow": function ( row, data, index ) {
            $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
            $('td', row).eq(6).addClass(data['status'] + '_fill');
        }
      })
    }

</script>

{% endblock %}
